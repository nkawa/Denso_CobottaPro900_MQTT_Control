# Denso_CobottaPro900_MQTT_Control マニュアル

## クイックスタート：MetaworkMQTTでのロボット制御

MetaworkMQTTでのロボット制御（VRゴーグル・コントローラでのロボット制御）の方法について説明する。

**1 ロボットの起動**

- 電源ケーブルをコンセントに挿す
- スマートTP（ティーチングペンダント、操作用のタブレット端末）が基本画面（左上部にMANUALまたはAUTOと表示される）に移行するまで待機する
- PCのプログラムから制御するには、自動モードになっている必要がある。画面左上のアイコンが[AUTO]になっていることを確認する。[MAN]（手動モード）になっている場合、タップして[AUTO]に切り替える
- パスワードの入力が必要な場合は、スマートTP上側面に貼られているテープに記載されているユーザー名とパスワードを使用する
- 緊急停止ボタンがOFFである（上に引いてある）ことを確認する。また、ロボット制御時に、緊急停止したい場合は緊急停止ボタンをONにする（押す）ことを確認しておく

**2 ロボットとPCの接続**

- ロボット（アームとハンド）とPCとをLANケーブルで接続する。アームのコントローラとスイッチ、ハンドのコントローラとスイッチ、PCとスイッチをそれぞれLANケーブルで接続する
- デフォルトでは、アームのIPアドレスは`192.168.5.45`、ハンドのIPアドレスは`192.168.5.46`に設定されている。PCのIPアドレスを同じネットワーク中の値に設定する。例えば、`ifconfig`でLANのインターフェース名（例：`enx00e04ccd5003`）を割り出し、IPアドレスとして例えば`192.168.5.1`を`sudo ifconfig enx00e04ccd5003 192.168.5.1 netmask 255.255.255.0`で割り当てる

**3 必要なライブラリのインストール**

必要な場合のみ行う。

```sh
pip install -r requirements.txt
```

**4 プログラムの実行**

MQTTサーバーが`sora2.uclab.jp`で動いていることが前提となる。Linuxでは、以下のコマンドでロボット制御コードを実行する。

```sh
sudo $(which python) src/main.py --tool-id <tool_id>
```

`sudo $(which python)`とするのは、リアルタイムスケジューラを利用するための設定である。この手法では、一時的にバイナリ（`python`）にリアルタイムスケジューラを利用するための権限を付与することができ、また仮想環境の`python`を用いる場合でも使用することができる。Windowsでのコマンドは未検証である。

現在アーム先端に付いているツールの番号を指定する。**ツールチェンジ時に他のツールと衝突する恐れがあるため、必ず正しいツールの番号を選ぶこと。**

ツールの番号の割り振りは以下の通り。

| id | ツール |
| - | - |
| 1 | OnRobot 2FG7 (パラレルグリッパー) |
| 2 | OnRobot VGC10 (真空グリッパー) |
| 3 | カッター |
| 4 | プレートホルダー |

GUI画面が起動する。ロボット制御用のボタン、状態表示のランプ、状態表示のログ画面が存在する。

ロボット制御側で、MQTTでの制御を受け付けるようにするためには、以下の手順で操作を行う。

1. `ConnectRobot`でロボットに接続
2. `ConnectMQTT`でMQTTサーバーに接続
3. `EnableRobot`でロボットのモーターをONにする。ロボットのモーターがONになっていれば、`Enabled`のランプが緑色に点灯する
4. `StartMQTTControl`でMQTTでの制御を受け付けるようにする。成功すれば`MQTTControl`のランプが緑色に点灯する

この状態で、VRゴーグルから`https://sora2.uclab.jp/cobotta`にアクセスし、タブの`Enter VR`または画面右下の`AR`を押すことで、VRコントローラでロボットを制御できるようになる。

ロボット制御側で、MQTTでの制御を止める場合は、`StopMQTTControl`を押す。成功すれば`MQTTControl`のランプが消える。

MQTTでの制御中に、エラーが起きた場合は、自動復帰可能なエラー（例：速度・加速度エラー）であれば、1度自動復帰を試みる。成功した場合、そのままMQTTでの制御が可能である。失敗した場合は、MQTTでの制御が止まる。また、自動復帰不可能なエラーの場合も、MQTTでの制御が止まる。

エラーが残っている場合、`Error`のランプが赤色に点灯する。エラーが起こると、モーターもOFFになることが多い。モーターを再度ONにする場合は、`ClearError`でエラー表示を消した後、`EnableRobot`を押せばよい。

`ReleaseHand`でハンドを最大まで開くことができる。`TidyPose`でロボットの先端がロボットの台の中央付近になり、先端が縦向きになる、片付け用の姿勢に移動できる。`DefaultPose`はロボットの先端がロボットの台の中央付近になるが、先端が横向きになる、姿勢に移動できる。`DisableRobot`でモーターをOFFにできる。閉じるボタンでロボット制御コードを終了できる。

`ToolChange`ではGUIからツールを切り替えることができる（VRからも切替可能）。ツールチェンジ時は、現在の位置から`TidyPose`で移動する場所に関節制御で移動してから、ツールホルダー間を移動してツールを切り替え、`TidyPose`で移動する場所に戻り、ツールチェンジ前の位置に戻る。

**現在の位置から`TidyPose`で移動する場所への移動の途中で障害物にぶつかることがないように、現在の位置を事前に、ワークや障害物から離れた位置で、作業台から上に十分離れた位置になるようにしておくこと。**

Tool 4（プレートホルダー）に切り替える場合は、ツールチェンジ後、ツールチェンジ前の位置ではなく、棚の上の真ん中の箱の手前まで移動する。箱下ろし作業は、GUIからは`DemoPutDownBox`を実行することで実行できる（VRからも切替可能）。

**現在は、Tool 4へのツールチェンジ後のロボットの位置からしか、箱下ろし作業を開始してはならない。**

当初の想定では、Tool 4へのツールチェンジ後のロボットの位置から、VRから操作してプレートホルダーで箱を引っ掛けてから、箱下ろし作業を行う予定だったが、この付近はIKが解けない、あるいは、IKを解くとTCP姿勢はほぼ同じだが関節角度が異なる姿勢を行ったり来たりするため障害物にぶつかりうる領域のためである。

ジョグ（関節空間でのジョグは`Joint Jog`, ベース座標系（X, Y, X, RX, RY, RZ）でのジョグは`TCP Jog`）が可能である。ジョグは長押しするとジョグ速度が大きくなる。ベース座標系でのジョグは特異姿勢付近でエラーになることがある。

**5 ロボットの終了**

ロボットの電源ケーブルをコンセントから抜くことで、メイン電源と制御用電源がOFFになる。

## 参考

- 公式ユーザーマニュアル（[DENSO ROBOT USER MANUALS](https://www.fa-manuals.denso-wave.com/jp/select.php)中のCOBOTTA PRO USER MANUALS、要ログイン）
